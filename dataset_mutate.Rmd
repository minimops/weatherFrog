---
title: "dataset_mutate"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(checkmate)
library(stringr)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggplot2)
library(tidyverse)
library(stringr)
```

```{r 0 functions}

source("dataset_mutate_funs.R")

```

takes raw datasets
  - saves them as dt
  - splits date and time
```{r 1 maindataset}
###caution!
#this does take quite a while
#for some reason format() is quite inefficient

##rean##

#import and convert to data.table
cli_data <- as.data.table(readRDS("Data/data_reanalysis_20201109.rds"))
#splitting Date and Time (takes a while)
cli_data[, date := as.Date(cli_data$time, tz = "CET")]
cli_data[, time := as.numeric(format(cli_data$time,"%H"))]
#saving dataset with split Date and time
saveRDS(cli_data, "Data/cli_data.rds")

#create an average over the day
cli_data_full_avgDay <- toDailyAverage(cli_data)
#save avg 2k dataset
saveRDS(cli_data_full_avgDay, "Data/cli_data_full_avgDay.rds")

#replace longitude and latitude with index and make wide (320 columns)
cli_data_full_avgDay_wide <- longToWide(toGeoIndex(cli_data_full_avgDay))
#save wide dataset
saveRDS(cli_data_full_avgDay_wide, "Data/cli_data_full_avgDay_wide.rds")


##gwl##

#import and convert to dt
gwl_data <- as.data.table(read.table("Data/GWL_1900-2010.csv", header = TRUE, sep = ";",
                                     na.strings = " "))
#wide to long:
gwl_data <- melt(gwl_data, id.vars = c("JAHRMONAT"), measure.vars = patterns("^X"),
                 variable.name = "day", value.name = "gwl")
#split year and month
gwl_data[, ":=" (year = substr(JAHRMONAT, 1, 4), 
                 month = substr(JAHRMONAT, 5, 6))][, JAHRMONAT := NULL]
#remove empty rows (months have differing lengths)
gwl_data <- gwl_data[gwl != "", ]
#rename and pad day
gwl_data_split <- copy(gwl_data[, day := str_pad(sub("X", "", day), 2, "left", "0")])
#save split dataset
saveRDS(gwl_data_split, "Data/gwl_split.rds")

#fuse to date
gwl_data[, date := as.Date(paste(year, month, day, sep = "-"))]
#delete columns
gwl_data[, ":=" (year = NULL, month = NULL, day = NULL)]
#reorder cols
setcolorder(gwl_data, c("date", "gwl"))
#save dataset with date format
saveRDS(gwl_data, "Data/gwl.rds")

```

this subsets the years 2000 to 2010
  - unifies the measure time
  - saves the avg over the day
```{r 2 last11years}
###requires 0 (and initially 1)


##rean##

#subset 2000-2010
cli_data_2k <- subsetYears(readRDS("Data/cli_data.rds"), seq(2000, 2010))
#change to winter time
cli_data_2k <- timeToWinter(cli_data_2k)
#save subset 2k dataset
saveRDS(cli_data_2k, "Data/cli_data_2k.rds")

#create an average over the day
cli_data_2k_avgDay <- toDailyAverage(cli_data_2k)
#save avg 2k dataset
saveRDS(cli_data_2k_avgDay, "Data/cli_data_2k_avgDay.rds")

#replace longitude and latitude with index and make wide (320 columns)
saveRDS(toGeoIndex(cli_data_2k_avgDay),"Data/cli_data_2k_avgDay_index.rds")
cli_data_2k_avgDay_wide <- longToWide(toGeoIndex(cli_data_2k_avgDay))
#save wide dataset
saveRDS(cli_data_2k_avgDay_wide, "Data/cli_data_2k_avgDay_wide.rds")

##gwl##

#subset years 2000-2010
gwl_2000s <- subsetYears(readRDS("Data/gwl_split.rds"), seq(2000, 2010))
#save subset
saveRDS(gwl_2000s, "Data/gwl_2000s_split.rds")

```

this subsets the years 2006 to 2010
  - unifies the measure time
  - saves the avg over the day
  - create a wide format of the dataset
  - create wide formats in 8x20 format
```{r 3 last5years}
###requires 0 (and initially 1)


##rean##

#subset 2000-2010
cli_data_05 <- subsetYears(readRDS("Data/cli_data.rds"), seq(2006, 2010))

#change to winter time
cli_data_05 <- timeToWinter(cli_data_05)
#save subset 2k dataset
saveRDS(cli_data_05, "Data/cli_data_05.rds")

#create avg over day
cli_data_05_avgDay <- toDailyAverage(cli_data_05)
#save avg
saveRDS(cli_data_05_avgDay, "Data/cli_data_05_avgDay.rds")

#replace longitude and latitude with index and make wide (320 columns)
saveRDS(toGeoIndex(cli_data_05_avgDay),"Data/cli_data_05_avgDay_index.rds")
cli_data_05_avg_wide <- longToWide(toGeoIndex(cli_data_05_avgDay))
#save wide dataset
saveRDS(cli_data_05_avg_wide, "Data/cli_data_05_avgDay_wide.rds")

#8x20 wide format mslp
cli_data_05_avgDay <- readRDS("Data/cli_data_05_avgDay.rds")
#remove geopot
all_days <- copy(cli_data_05_avgDay)[, avg_geopot := NULL]
#to wide
cli_data_05_avgDay_mslp_all <- longToWide(all_days,  id = c("date", "latitude"), col = "longitude", vars = "avg_mslp")
# change col names to shorten
names(cli_data_05_avgDay_mslp_all) <- c("date", "latitude", unlist(lapply(as.numeric(names(cli_data_05_avgDay_mslp_all)[3:22]), function(x) round(x, 2))))
# save
saveRDS(cli_data_05_avgDay_mslp_all, "Data/cli_data_05_mslp_wide.rds")

#same for geopot
all_days_geo <- copy(cli_data_05_avgDay)[, avg_mslp := NULL]
cli_data_05_avgDay_geo_all <- longToWide(all_days_geo,  id = c("date", "latitude"), col = "longitude", vars = "avg_geopot")
names(cli_data_05_avgDay_geo_all) <- c("date", "latitude", unlist(lapply(as.numeric(names(cli_data_05_avgDay_geo_all)[3:22]), function(x) round(x, 2))))
#save
saveRDS(cli_data_05_avgDay_geo_all, "Data/cli_data_05_geo_wide.rds")

#same for both
cli_data_05_avgDay_both_all <- longToWide(copy(cli_data_05_avgDay),  id = c("date", "latitude"), col = "longitude")
names(cli_data_05_avgDay_both_all)[1:22] <- c("date", "latitude", unlist(lapply(names(cli_data_05_avgDay_both_all)[3:22], function(x) paste0(str_sub(x, start = 10, end = 15), "_avg.mslp"))))
names(cli_data_05_avgDay_both_all)[23:42] <- unlist(lapply(names(cli_data_05_avgDay_both_all)[23:42], function(x) paste0(str_sub(x, start = 12, end = 17), "_avg.geo")))
#save
saveRDS(cli_data_05_avgDay_both_all, "Data/cli_data_05_wide.rds")



##gwl##

#subset years 2006-2010
gwl_5_years <- subsetYears(readRDS("Data/gwl_split.rds"), seq(2006, 2010))
#save subset
saveRDS(gwl_5_years, "Data/gwl_5_years_split.rds")

```

this subsets the years 2000 to 2010
  - unifies the measure time
  - saves the avg over the day
```{r 4 1971-2000 "30"}
###requires 0 (and initially 1)


##rean##

#subset 2000-2010
cli_data_30 <- subsetYears(readRDS("Data/cli_data.rds"), seq(1971, 2000))
#change to winter time
cli_data_30 <- timeToWinter(cli_data_30)
#save subset 2k dataset
saveRDS(cli_data_30, "Data/cli_data_30.rds")

#create an average over the day
cli_data_30_avgDay <- toDailyAverage(cli_data_30)
#save avg 2k dataset
saveRDS(cli_data_30_avgDay, "Data/cli_data_30_avgDay.rds")

#replace longitude and latitude with index and make wide (320 columns)
saveRDS(toGeoIndex(cli_data_30_avgDay),"Data/cli_data_30_avgDay_index.rds")
cli_data_30_avgDay_wide <- longToWide(toGeoIndex(cli_data_30_avgDay))
#save wide dataset
saveRDS(cli_data_30_avgDay_wide, "Data/cli_data_30_avgDay_wide.rds")

```

reanalysis dataset and gwl dataset united in one dataset from 1971 to 2010
one row contains one day with all measure points of mslp and geopotential
require cli_data.rds and 
        GWL_1900-2010.csv
used for Analyse GWL: differences in season? differ first and last day of one GWL compared to the other days?
```{r 5 1971-2000 unifies GWL and reanalysis data}

####################GWL data
gwl_data <- as.data.table(read.table("Data/GWL_1900-2010.csv", header = TRUE, sep = ";",
                                     na.strings = " "))

#wide to long with calendaric sequence of the date

gwl_data_long <- as.data.frame(t(gwl_data))
colnames(gwl_data_long) <- gwl_data$JAHRMONAT
gwl_data_long <- gwl_data_long[-1,]
day <- seq(from = 1, to = 31, by = 1)
gwl_data_long <- cbind(day, gwl_data_long)
gwl_data_long <- as.data.table(gather(data = gwl_data_long,key = JAHRMONAT, value = gwl, -day))

#Remove empty rows

gwl_data_long <- gwl_data_long[!(apply(gwl_data_long, 1, function(y) any(y == ""))),]

#########################################

#split year and month
gwl_data_long[, ":=" (year = substr(JAHRMONAT, 1, 4), 
                      month = substr(JAHRMONAT, 5, 6))][, JAHRMONAT := NULL]
#rename and pad day
gwl_data_split <- copy(gwl_data_long[, day := str_pad(sub("X", "", day), 2, "left", "0")])
#fuse to date
gwl_data_long[, date := as.Date(paste(year, month, day, sep = "-"))]

#reorder cols
setcolorder(gwl_data_long, c("date", "day","month","year","gwl"))

#subset timeframe

gwl1971 <- gwl_data_long[year %in% seq(1971, 2010), ]
saveRDS(gwl1971, file ="Data\\gwl1971.rds")


##############reanalysis data 


cli_data <- readRDS("Data/cli_data.rds")
#subset 1971-2010
cli_data_1971 <- copy(cli_data)[format(as.Date(date),"%Y") %in% seq(1971, 2010), ]
#unify time stamps
#table(format(cli_data_2k$date, "%m"), cli_data_2k$time)
#subtract 1 from all summer-time timestamps
#TODO neaten this up
cli_data_1971$time[which(cli_data_1971$time %in% c(1, 7, 13, 19))] <- 
  cli_data_1971$time[which(cli_data_1971$time %in% c(1, 7, 13, 19))] - 1

#create an average over the day
cli_data_1971_avgDay <- copy(cli_data_1971)[, .(avg_mslp = mean(mslp),
                                                avg_geopot = mean(geopotential)),
                                            by = .(date, longitude, latitude)]


#replace longitude and latitude with indeciies
cli_data_1971_avgDay_index <- copy(cli_data_1971_avgDay)
setorder(cli_data_1971_avgDay_index, date, longitude, latitude)

cli_data_1971_avgDay_index[, geoIndex := 1:.N, by = date][, ":=" (longitude = NULL,
                                                                  latitude = NULL)]


#create wide format dataset
cli_data_1971_avg_wide <- dcast(copy(cli_data_1971_avgDay_index),
                                date ~ geoIndex,
                                value.var = c("avg_mslp", "avg_geopot"))


cli_data_1971_avg_wide[, ":=" (year = substr(date, 1, 4), 
                               month = substr(date, 6, 7),
                               day = substr(date,9,10))][, date := NULL]

# one day is equal to one row
cli_data_1971_avg_wide[, date := as.Date(paste(year, month, day, sep = "-"))]

saveRDS(cli_data_1971_avg_wide, "Data/cli_data_1971_avgDay_wide.rds")




#####################################
# unify reanalysis data and gwl data

cli_gwl_1971 <- merge(gwl1971,cli_data_1971_avg_wide, by = c("date","year","month","day"))
cli_gwl_1971$id <- seq(from = 1, to = nrow(cli_gwl_1971),by = 1)
setcolorder(cli_gwl_1971, c("id"))

index_length_gwl <-  rleid(cli_gwl_1971$gwl)

cli_gwl_1971 <- cbind(index_length_gwl,cli_gwl_1971)


# add column season 

cli_gwl_1971 <- cli_gwl_1971 %>%
  mutate(Jahreszeit = case_when(month %in% c("12", "01", "02") ~ "Winter",
                                month %in% c("03", "04", "05") ~ "Fruehling",
                                month %in% c("06", "07", "08") ~ "Sommer",
                                month %in% c("09", "10", "11") ~ "Herbst") )
setcolorder(cli_gwl_1971,c("index_length_gwl","id","Jahreszeit")) 
cli_gwl_1971 <- as.data.table(cli_gwl_1971)

saveRDS(cli_gwl_1971,"Data\\cli_gwl_1971_wide.rds")


```



change cli_gwl_1971 from above into long format: one column for mslp and one column for geopotential 

```{r 6 1971-2000  long format} 

#long format for mslp
cli_gwl_long_mslp <- melt(cli_gwl_1971, id.vars = c("Jahreszeit","index_length_gwl","date","year","month","day","gwl"), measure.vars = c(colnames(cli_gwl_1971[,9 : 168])))
names(cli_gwl_long_mslp) <- c("Jahreszeit","index_length_gwl","date","year","month","day","gwl",
                               "variable_mslp","value_mslp")

#long format for geopotential

cli_gwl_long_geo <- melt(cli_gwl_1971, id.vars = c("Jahreszeit","index_length_gwl","date","year","month","day","gwl"), measure.vars = c(colnames(cli_gwl_1971[,169 : 328])))
names(cli_gwl_long_geo) <- c("Jahreszeit","index_length_gwl","date","year","month","day","gwl",
                              "variable_geo","value_geo")


#unite both data tables 
cli_gwl_long <- cbind(cli_gwl_long_mslp,cli_gwl_long_geo[,8:9])

saveRDS(cli_gwl_long,"Data\\cli_gwl_1971_long.rds")

```

creates saved maps
```{r M maps}

# load data
world <- ne_countries(scale = "medium", returnclass = "sf")

# world map
world_map <- ggplot(data = world) +
  geom_sf() +
  labs( x = "Longitude", y = "Latitude") +
  ggtitle("World map")
#save world map
saveRDS(world_map, "Data/world_map.rds")

#get data
cli_data_2k_avgDay <- readRDS("Data/cli_data_2k_avgDay.rds")
#subsetting just one day
one_day <- copy(cli_data_2k_avgDay)[format(date, "%Y-%m-%d")
                                    %in% c("2006-01-01"), ]
#world map in range
world_map_local <- world_map +
  coord_sf(xlim = c(min(one_day$longitude) - 5, 
                    max(one_day$longitude) + 5), 
           ylim = c(min(one_day$latitude) - 5, 
                    max(one_day$latitude) + 5), expand = FALSE)

#save world map local
saveRDS(world_map_local, "Data/world_map_local.rds")


diff_lon <- abs(unique(one_day$longitude)[[1]] - unique(one_day$longitude)[[2]]) / 2
diff_lat <- abs(unique(one_day$latitude)[[1]] - unique(one_day$latitude)[[2]]) / 2

saveRDS(c(diff_lon, diff_lat), "Data/diff_coords.rds")
```